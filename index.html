<!DOCTYPE html>
<html lang="fr">

<head>
    <meta charset="UTF-8" />
     <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Liste de courses collaborative</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            background: #f4f4f4;
            padding: 20px;
        }

        h1 {
            text-align: center;
        }

        h2 {
            margin-top: 30px;
            text-align: center;
        }

        input,
        select,
        button {
            padding: 6px;
            margin: 5px 0;
        }

        button {
            cursor: pointer;
        }
        
         ul {
            list-style: none;
            padding: 0;
        }

        li {
            padding: 5px;
            margin: 5px 0;
            background-color: #eee;
            border-radius: 5px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        #foods-list li {
            display: inline;
            background-color: transparent;
        }

        #foods-list button {
            box-shadow: 1px 1px 4px silver;
            border: none;
            padding: 10px;
            border-radius: 40px;
        }

        #shoppingLists {
            display: flex;
            gap: 30px;
            flex-wrap: wrap;
        }

        #shoppingLists li {
            cursor: pointer;
        }

        #shoppingLists li:hover, #shoppingLists li:active {
            transition: background-color 300ms ease-in-out;
            background-color: #c4c4c4;
        }

        #participants-popup {
            border-top-left-radius: 24px;
            border-top-right-radius: 24px;
            box-shadow: 1px 1px 4px silver;
            position: fixed;
            z-index: 2;
            left: 0;
            right: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            background-color: white;
        }

        #participants-popup ul {
            display: flex;
            flex-direction: column;
            align-items: center;
            background-color: white;
            width: 100%
        }

        #participants-popup button {
            border: none;
            background-color: transparent;
            width: 100%;
        }

        #participants-popup li {
            border-bottom: 1px solid;
            background-color: transparent;
            width: 100%;
            justify-content: center;
        }

        #taken-btn-ctnr {
            position: absolute;
            top: 40px;
            right: 16px;
        }

        #taken-btn-ctnr button {
            border-radius: 20px;
            background-color: #c4c4c4;
        }

        #taken-btn-ctnr button:hover,
        #taken-btn-ctnr button:active {
            transition: background-color 300ms ease-in-out;
            background-color: #a9a8a8;   
        }

        .out-of-screen {
            bottom: -100vh;
        }

        .show {
            transition: bottom 300ms ease-in-out;
            bottom: 0
        }

        .hide {
            transition: bottom 300ms ease-in-out;
            bottom: -100vh
        }

        .container {
            display: flex;
            gap: 30px;
            flex-wrap: wrap;
            justify-content: center;
        }

        .box {
            background: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 0 5px rgba(0, 0, 0, 0.1);
            width: 100%;
            text-align: center;
        }

        .small {
            font-size: 0.9em;
            color: #555;
        }

        @media all and (max-width: 540px) {
            #shoppingLists > div {
                width: 100%
            }
        }
    </style>
</head>

<body>

    <h1>üõí Liste des courses</h1>

    <div class="container">

        <!-- Participants -->
        <!-- <div class="box">
            <h2>Participants</h2>
            <input type="text" id="participantInput" placeholder="Nom du participant">
            <button id="addParticipantBtn">Ajouter</button>
            <ul id="participantsList"></ul>
        </div> -->        

        <!-- Listes de courses -->
        <div class="box">
            <h2>Qui prend quoi</h2>
            <form id="searchInputForm">
                <input type="text" placeholder="Rechercher..."/>
                <button>üîç</button>
            </form>
            <div id="shoppingLists"></div>
        </div>

        <!-- Aliments -->
        <div class="box">
            <h2>Ajouter un aliment</h2>
            <input type="text" id="foodInput" placeholder="Nom de l'aliment">
            <!-- <select id="participantSelect"></select> -->
            <button id="addFoodBtn">Ajouter</button>
            <ul id="foods-list"></ul>
        </div>

        <div id="participants-popup" class="out-of-screen">
            <h2>Qui prend ?</h2>
            <div id="taken-btn-ctnr">
                <button>A prendre</button>
            </div>
            <ul>
                <li><button style="color:red">Supprimer</button></li>
            </ul>
        </div>

    </div>
    <script src="https://www.gstatic.com/firebasejs/12.7.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/12.7.0/firebase-firestore-compat.js"></script>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-app.js";


        const firebaseConfig = {
            apiKey: "AIzaSyDc48VoXiyktOhif-LK0ms88KUijga4cmw",
            authDomain: "listecoursenouvelan.firebaseapp.com",
            projectId: "listecoursenouvelan",
            storageBucket: "listecoursenouvelan.firebasestorage.app",
            messagingSenderId: "804132489018",
            appId: "1:804132489018:web:f1b74413408610cc0af203"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);

        const db = firebase.firestore();
        let participants = [];
        let foodsWithoutParticipant = [];
        const participantsPopup = document.querySelector("#participants-popup");
        const takenBtn = document.querySelector("#taken-btn-ctnr button");
        let selectedFoodIndex = -1;
        let selectedParticipantIndex = -1;
        let foods = [];
        // const addParticipantBtn = document.getElementById("addParticipantBtn");
        // addParticipantBtn.addEventListener("click", () => {
        //     addParticipant();
        // });

        takenBtn.addEventListener("click", e => {
            const participant = participants[selectedParticipantIndex];
            const food = participant.foods[selectedFoodIndex];
            const ref = db.collection("foods").doc(food.id);
            ref.update({
                taken: !food.taken
            }).then(() => {
                food.taken = !food.taken;
                e.target.innerHTML = food.taken ? "D√©ja pris" : "A prendre";
                participant.foods
                .sort((a,b) => a.name < b.name ? -1 : a.name > b.name ? 1 : 0)
                .sort((a,b) => a.taken === b.taken ? 0 : a.taken ? -1 : 1);
                console.log(participant.foods);
                render();
            });
        })

        const addFoodBtn = document.getElementById("addFoodBtn");
        addFoodBtn.addEventListener("click", () => {
            addFood();
        });

        const searchInputForm = document.getElementById("searchInputForm");
        const searchInput = searchInputForm.querySelector("input");

        searchInputForm.addEventListener("submit", e => {
            e.preventDefault();
            const formatedSearchValue = searchInput.value.trim().toLowerCase();
            for(let i = 0, l = foods.length; i < l; i++) {
                const food = foods[i];
                if(food.formatedName.match(formatedSearchValue)) {
                    window.scrollTo({
                        top: document.querySelector(`li[data-i="${food.i}"]`).dataset.y,
                        left: 0,
                        behavior: "smooth",
                    })
                    break;
                }

            }
        })

        async function initDataFromFirebase() {
            foods = await getItemsFromDb("foods");
            foods = foods
            .sort((a,b) => a.name < b.name ? -1 : a.name > b.name ? 1 : 0)
            .sort((a,b) => a.taken === b.taken ? 0 : a.taken ? -1 : 1)
            .map((f, i) => ({...f, formatedName: f.name.toLowerCase(), i}));
            participants = await getItemsFromDb("participants");
            participants = participants.map(p => ({...p, foods: foods.filter(f => f.participantId === p.id)}));
            foodsWithoutParticipant = foods.filter(f => !f.participantId);
            renderParticipantsPopup();
            render();
        }

        async function getItemsFromDb(collectionName) {
            const querySnapshot = await db.collection(collectionName).get()
            const items = [];
            querySnapshot.forEach((doc) => {
                const item = doc.data();
                items.push({...item, id : doc.id});
            });
            return items;
        }

        async function addItemInDb(collectionName, data) {
            const docRef = await db.collection(collectionName).add(data);
            console.log("Document written with ID: ", docRef.id);
            console.log(docRef.id);
            return docRef.id;
        }

        async function removeItemFromDB(collectionName, id) {
            db.collection(collectionName).doc(id).delete().then(() => {
                console.log("Document successfully deleted!");
            }).catch((error) => {
                console.error("Error removing document: ", error);
            });
        }

        // async function addParticipant() {
        //     const input = document.getElementById("participantInput");
        //     const name = input.value.trim();
        //     if (!name) return;           
        //     const id = await addItemInDb("participants", {name});
        //     participants.push({ name, foods: [], id});
        //     input.value = "";
        //     render();
        // }
 
        // function removeParticipant(index) {
        //     const {id, foods} = participants[index];
        //     console.log(id, foods);
        //     participants.splice(index, 1);
        //     removeItemFromDB("participants", id).then(() => {
        //         const promises = foods.map(food => new Promise((resolve) => {
        //             removeItemFromDB("foods", food.id).then(() => {
        //                 resolve("ok");
        //             });
        //         }));
        //         Promise.all(promises).then(res => {
        //             render();
        //         });
        //     });
        // }
  // async function updateAllFoods() {
        //     foods = await getItemsFromDb("foods");
        //     const promises = foods.map(food => new Promise((resolve) => {
        //         const ref = db.collection("foods").doc(food.id);
        //         ref.update({taken: false}).then(res => {
        //             console.log(res); 
        //             resolve("ok") 
        //         });
        //     }));
        //     Promise.all(promises).then(res => {
        //         console.log("done !");
        //     });
        // }
        // updateAllFoods();
   
        async function addFood() {
            const foodInput = document.getElementById("foodInput");
            const food = foodInput.value.trim();
            // const participantIndex = document.getElementById("participantSelect").value;

            if (!food) return;
            const newFood = {name: food, participantId: "", taken: false};
            const id = await addItemInDb("foods", newFood);
            const newFoodWithId = {...newFood, id};
            
            foodsWithoutParticipant.push(newFoodWithId)
            
            foodInput.value = "";
            render();
        }

        async function attributeSelectedFoodToParticipant(participantId) {
            console.log(selectedParticipantIndex, selectedParticipantIndex > -1);
            const food = selectedParticipantIndex > -1 ? participants[selectedParticipantIndex].foods[selectedFoodIndex] : foodsWithoutParticipant[selectedFoodIndex];
            const ref = db.collection("foods").doc(food.id);

            const res = await ref.update({
                participantId
            });
            return res;
        }

        function removeFood() {
            let foodId;
            if (selectedParticipantIndex > -1) {
                const participant =  participants[selectedParticipantIndex];
                foodId = participant.foods[selectedFoodIndex].id
                participant.foods.splice(selectedFoodIndex, 1);
                selectedParticipantIndex = -1;
            } else {
                foodId = foodsWithoutParticipant[selectedFoodIndex].id;
                foodsWithoutParticipant.splice(selectedFoodIndex, 1);
            }
            
            participantsPopup.className = "hide";
            removeItemFromDB("foods", foodId).then(() => {
                render();
            });
        }

        function showParticipantsPopup(fi, pi, foodIsTaken) {
            selectedFoodIndex = fi;
            if(pi >= 0) {
                selectedParticipantIndex = pi;
            }
            participantsPopup.className = "show";
            takenBtn.innerHTML = foodIsTaken ? "D√©ja pris" : "A prendre";

        }

        function render() {
            // Participants list
            // const participantsList = document.getElementById("participantsList");
            // participantsList.innerHTML = "";

            // participants.forEach((p, i) => {
            //     const li = document.createElement("li");
            //     li.innerHTML = `
            //         ${p.name}
            //         <button>‚ùå</button>
            //     `;
            //     li.querySelector("button").addEventListener("click", () => {
            //         removeParticipant(i);
            //     })
            //     participantsList.appendChild(li);
            // });

            // Participant select
            // const select = document.getElementById("participantSelect");
            // select.innerHTML = `<option value="">-- Choisir --</option>`;
            // participants.forEach((p, i) => {
            //     const option = document.createElement("option");
            //     option.value = i;
            //     option.textContent = p.name;
            //     select.appendChild(option);
            // });
            // const option = document.createElement("option");
            // option.value = -1;
            // option.textContent = "Personne pour l'instant";
            // select.appendChild(option);

            const foodsList = document.getElementById("foods-list");
            foodsList.innerHTML = "";
            foodsWithoutParticipant.forEach((food, fi) => {
                 const li = document.createElement("li");
                    li.innerHTML = `
                    <button class="food-btn">
                        ${food.name}
                    </button>
                    `;
                    li.querySelector("button").addEventListener("click", () => {
                        showParticipantsPopup(fi, -1, food.taken);
                    })
                    foodsList.appendChild(li);
            });

            // Shopping lists
            const shoppingLists = document.getElementById("shoppingLists");
            shoppingLists.innerHTML = "";

            participants.forEach((p, pi) => {
                const div = document.createElement("div");
                div.innerHTML = `<strong>${p.name}</strong>`;
                shoppingLists.appendChild(div);
                const ul = document.createElement("ul");
                div.appendChild(ul);
                p.foods.forEach((food, fi) => {
                    const li = document.createElement("li");
                    li.innerHTML = `
                        <span class="small">${food.name}</span>
                        <span class="small">${food.taken ? "‚úì" : ""}</span>
                    `;
                     // <button>‚ùå</button>
                    // li.querySelector("button").addEventListener("click", () => {
                    //     removeFood(pi, fi);
                    // })
                    li.addEventListener("click", () => {
                        showParticipantsPopup(fi, pi, food.taken);
                    })
                    ul.appendChild(li);
                    li.dataset.y = li.getBoundingClientRect().y;
                    li.dataset.i = food.i;
                });
            });
            

        }
    
        function renderParticipantsPopup() {
            const participantsPopupUl = participantsPopup.querySelector("ul");
            participantsPopupUl.querySelector("button").addEventListener("click", () => {
                removeFood();
            });
            participants.forEach((participant) => {
                const li = document.createElement("li");
                li.innerHTML = `<button>
                    ${participant.name}
                </button>`;
                li.querySelector("button").addEventListener("click", () => {
                    attributeSelectedFoodToParticipant(participant.id).then(res => {
                        let food;
                        if(selectedParticipantIndex > -1) {
                            const participant2 = participants[selectedParticipantIndex];
                            food = {...participant2.foods[selectedFoodIndex]};
                            participant2.foods.splice(selectedFoodIndex, 1);
                            selectedParticipantIndex = -1;
                        } else {
                            food = {...foodsWithoutParticipant[selectedFoodIndex]};
                            foodsWithoutParticipant.splice(selectedFoodIndex, 1);
                        }
                       
                        participant.foods.push(food);
                        participantsPopup.className = "hide";
                        render();
                    })
                });
                participantsPopupUl.appendChild(li);
            });
            const li = document.createElement("li");
            li.innerHTML = `<button>Fermer</button>`;
            li.querySelector("button").addEventListener("click", () => {  
                selectedParticipantIndex = -1;                 
                participantsPopup.className = "hide";
            });
            participantsPopupUl.appendChild(li);
        }

        initDataFromFirebase();

      
   </script>

</body>

</html>